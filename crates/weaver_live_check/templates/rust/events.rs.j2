// SPDX-License-Identifier: Apache-2.0
{%- import "macros.j2" as macros %}

//! Generated event types and log record builders for live check findings.
//!
//! DO NOT EDIT — this file is generated by Weaver from `model/live_check.yaml`.
//! To regenerate, run from the repository root:
//!
//! ```sh
//! weaver registry generate \
//!   --registry crates/weaver_live_check/model/ \
//!   --templates crates/weaver_live_check/templates/ \
//!   --v2 \
//!   rust \
//!   crates/weaver_live_check/src/
//! ```
//!
//! Each `populate_*_log_record` function sets the event name, severity, body,
//! and all attributes on the record. Template-type attributes accept
//! `&[(Key, AnyValue)]` slices where each key is a suffix that gets prefixed
//! with the attribute's namespace constant.

use opentelemetry::logs::{AnyValue, LogRecord, Severity};
use opentelemetry::Key;

#[allow(clippy::wildcard_imports)]
use super::attributes::*;

{% for event in ctx.registry.events %}
{% set event_short = event.name | split(".") | last %}

/// Event name for: {{ event.brief | lower }}
pub const {{ event.name | screaming_snake_case }}: &str = "{{ event.name }}";

/// Populate a log record for the `{{ event.name }}` event.
///
{{ macros.doc_note(event.note) -}}
pub fn populate_{{ event_short }}_log_record(
    log_record: &mut impl LogRecord,
    body: impl Into<AnyValue>,
    severity: Severity,
{% for attr in event.attributes %}
{% set param_name = attr.key | split(".") | last %}
{% set is_template = attr.type is string and "template" in attr.type %}
{% set is_enum = attr.type is mapping and attr.type.members is defined %}
{% set is_array = not is_template and attr.type is string and "[]" in attr.type %}
{% set is_required = attr.requirement_level is string and attr.requirement_level == "required" %}
{% if is_template %}
    {{ param_name }}: &[(Key, AnyValue)],
{% elif is_enum %}
{% set enum_type = macros.enum_name(attr) %}
{% if is_required %}
    {{ param_name }}: &{{ enum_type }},
{% else %}
    {{ param_name }}: Option<&{{ enum_type }}>,
{% endif %}
{% elif is_array %}
{% set element = attr.type | replace("[]", "") %}
{% if element == "string" %}{% set rust_element = "String" %}
{% elif element == "int" %}{% set rust_element = "i64" %}
{% elif element == "double" %}{% set rust_element = "f64" %}
{% elif element == "boolean" %}{% set rust_element = "bool" %}
{% endif %}
{% if is_required %}
    {{ param_name }}: &[{{ rust_element }}],
{% else %}
    {{ param_name }}: Option<&[{{ rust_element }}]>,
{% endif %}
{% else %}
{# Scalar primitive: string, int, double, boolean #}
{% if attr.type == "int" %}{% set rust_type = "i64" %}{% set is_copy = true %}
{% elif attr.type == "double" %}{% set rust_type = "f64" %}{% set is_copy = true %}
{% elif attr.type == "boolean" %}{% set rust_type = "bool" %}{% set is_copy = true %}
{% else %}{% set rust_type = "str" %}{% set is_copy = false %}
{% endif %}
{% if is_required %}
    {{ param_name }}: {% if not is_copy %}&{% endif %}{{ rust_type }},
{% else %}
    {{ param_name }}: Option<{% if not is_copy %}&{% endif %}{{ rust_type }}>,
{% endif %}
{% endif %}
{% endfor %}
) {
    log_record.set_event_name({{ event.name | screaming_snake_case }});
    log_record.set_severity_number(severity);
    log_record.set_severity_text(severity.name());
    log_record.set_body(body.into());
{% for attr in event.attributes %}
{% set param_name = attr.key | split(".") | last %}
{% set attr_const = attr.key | screaming_snake_case %}
{% set is_template = attr.type is string and "template" in attr.type %}
{% set is_enum = attr.type is mapping and attr.type.members is defined %}
{% set is_array = not is_template and attr.type is string and "[]" in attr.type %}
{% set is_required = attr.requirement_level is string and attr.requirement_level == "required" %}
{# Determine AnyValue conversion expressions #}
{% if is_enum %}
{% set conv_req = "AnyValue::from(" ~ param_name ~ ".to_string())" %}
{% set conv_opt = "AnyValue::from(val.to_string())" %}
{% elif attr.type == "string" %}
{% set conv_req = "AnyValue::from(" ~ param_name ~ ".to_owned())" %}
{% set conv_opt = "AnyValue::from(val.to_owned())" %}
{% elif is_array %}
{% set conv_req = "AnyValue::ListAny(Box::new(" ~ param_name ~ ".iter().map(|v| AnyValue::from(v.clone())).collect()))" %}
{% set conv_opt = "AnyValue::ListAny(Box::new(val.iter().map(|v| AnyValue::from(v.clone())).collect()))" %}
{% else %}
{# Copy scalars: int, double, boolean — AnyValue::from works directly #}
{% set conv_req = "AnyValue::from(" ~ param_name ~ ")" %}
{% set conv_opt = "AnyValue::from(val)" %}
{% endif %}
{% if is_template %}
    for (suffix, value) in {{ param_name }} {
        log_record.add_attribute(
            Key::from(format!("{}.{}", {{ attr_const }}, suffix.as_str())),
            value.clone(),
        );
    }
{% elif is_required %}
    log_record.add_attribute(Key::from({{ attr_const }}), {{ conv_req }});
{% else %}
    if let Some(val) = {{ param_name }} {
        log_record.add_attribute(Key::from({{ attr_const }}), {{ conv_opt }});
    }
{% endif %}
{% endfor %}
}
{% endfor %}
