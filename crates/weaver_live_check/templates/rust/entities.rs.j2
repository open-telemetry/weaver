// SPDX-License-Identifier: Apache-2.0
{%- import "macros.j2" as macros %}

//! Generated entity types, attribute constants, and enum types.
//!
//! DO NOT EDIT â€” this file is generated by Weaver from `model/live_check.yaml`.
//! To regenerate, run from the repository root:
//!
//! ```sh
//! weaver registry generate \
//!   --registry crates/weaver_live_check/model/ \
//!   --templates crates/weaver_live_check/templates/ \
//!   --v2 \
//!   rust \
//!   crates/weaver_live_check/src/
//! ```

#[allow(unused_imports)]
use serde::{Deserialize, Serialize};

use opentelemetry::KeyValue;

{% for entity in ctx.registry.entities %}
{% set struct_name = entity.type | pascal_case %}
// --- {{ entity.type }} entity ---

// Attribute key constants
{% for attr in entity.identity %}
{{ macros.attr_const(attr) }}
{% endfor %}
{% for attr in entity.description %}
{{ macros.attr_const(attr) }}
{% endfor %}

/// {{ entity.brief | trim }}
///
{{ macros.doc_note(entity.note) }}
#[derive(Debug, Clone)]
pub struct {{ struct_name }} {
{% for attr in entity.identity %}
{% set field_name = attr.key | split(".") | last %}
    /// {{ attr.brief | trim }}
    pub {{ field_name }}: {{ macros.rust_owned_type(attr) }},
{% endfor %}
{% for attr in entity.description %}
{% set field_name = attr.key | split(".") | last %}
    /// {{ attr.brief | trim }}
    pub {{ field_name }}: Option<{{ macros.rust_owned_type(attr) }}>,
{% endfor %}
}

impl {{ struct_name }} {
    /// Convert this entity's attributes to OpenTelemetry resource attributes.
    #[must_use]
    pub fn to_resource_attributes(&self) -> Vec<KeyValue> {
        let mut attrs = Vec::new();
{% for attr in entity.identity %}
{% set field_name = attr.key | split(".") | last %}
{% set attr_const = attr.key | screaming_snake_case %}
{% set is_copy = attr.type == "int" or attr.type == "double" or attr.type == "boolean" %}
{% set is_enum = attr.type is mapping and attr.type.members is defined %}
{% if is_copy %}
        attrs.push(KeyValue::new({{ attr_const }}, self.{{ field_name }}));
{% elif is_enum %}
        attrs.push(KeyValue::new({{ attr_const }}, self.{{ field_name }}.to_string()));
{% else %}
        attrs.push(KeyValue::new({{ attr_const }}, self.{{ field_name }}.clone()));
{% endif %}
{% endfor %}
{% for attr in entity.description %}
{% set field_name = attr.key | split(".") | last %}
{% set attr_const = attr.key | screaming_snake_case %}
{% set is_copy = attr.type == "int" or attr.type == "double" or attr.type == "boolean" %}
{% set is_enum = attr.type is mapping and attr.type.members is defined %}
{% if is_copy %}
        if let Some(val) = self.{{ field_name }} {
            attrs.push(KeyValue::new({{ attr_const }}, val));
        }
{% elif is_enum %}
        if let Some(val) = &self.{{ field_name }} {
            attrs.push(KeyValue::new({{ attr_const }}, val.to_string()));
        }
{% else %}
        if let Some(val) = &self.{{ field_name }} {
            attrs.push(KeyValue::new({{ attr_const }}, val.clone()));
        }
{% endif %}
{% endfor %}
        attrs
    }
}

{% set has_enums = false %}
{%- for attr in entity.identity %}
{%- if attr.type is mapping and attr.type.members is defined %}{% set has_enums = true %}{% endif %}
{%- endfor %}
{%- for attr in entity.description %}
{%- if attr.type is mapping and attr.type.members is defined %}{% set has_enums = true %}{% endif %}
{%- endfor %}
{%- if has_enums %}

// --- {{ entity.type }} enums ---
{% for attr in entity.identity %}
{% if attr.type is mapping and attr.type.members is defined %}
{{ macros.enum_def(attr) }}
{% endif %}
{% endfor %}
{% for attr in entity.description %}
{% if attr.type is mapping and attr.type.members is defined %}
{{ macros.enum_def(attr) }}
{% endif %}
{% endfor %}
{%- endif %}
{% endfor %}
